# Requirements Document

## Introduction

This specification defines the requirements for migrating the Tilly application from Clerk authentication to Jazz's native Passkey authentication system. The migration aims to simplify the authentication stack, reduce external dependencies, and leverage Jazz's built-in local-first authentication capabilities while maintaining all existing user functionality.

## Glossary

- **Tilly Application**: The relationship management application being migrated
- **Clerk**: Third-party authentication service currently in use
- **Jazz Passkey Auth**: Jazz's built-in WebAuthn-based authentication system
- **Passkey**: WebAuthn credential stored in browser/OS for biometric authentication
- **Server Worker**: Jazz server-side account that processes authenticated requests
- **Auth Token**: Cryptographically signed token generated by Jazz client for API authentication

## Requirements

### Requirement 1: Remove Clerk Dependencies

**User Story:** As a developer, I want to remove all Clerk dependencies from the codebase, so that the application has fewer external dependencies and reduced complexity.

#### Acceptance Criteria

1. WHEN the migration is complete, THE Tilly Application SHALL NOT contain any Clerk package imports
2. WHEN the migration is complete, THE Tilly Application SHALL NOT reference any Clerk environment variables
3. WHEN the migration is complete, THE Tilly Application SHALL NOT contain any Clerk-specific code or components
4. WHEN the migration is complete, THE Tilly Application SHALL successfully build without Clerk dependencies

### Requirement 2: Implement Passkey Authentication UI

**User Story:** As a user, I want to authenticate using passkeys, so that I can securely access my account using biometric authentication.

#### Acceptance Criteria

1. WHEN a new user visits the application, THE Tilly Application SHALL display a signup dialog with passkey creation option
2. WHEN a returning user visits the application, THE Tilly Application SHALL display a login dialog with passkey authentication option
3. WHEN a user completes passkey signup, THE Tilly Application SHALL create a new Jazz account with public profile
4. WHEN a user completes passkey login, THE Tilly Application SHALL authenticate the user and load their account data
5. WHERE the user's browser supports WebAuthn, THE Tilly Application SHALL enable passkey authentication

### Requirement 3: Update Account Schema with Public Profile

**User Story:** As a user, I want my profile to be publicly readable, so that other users can see my display name when collaborating.

#### Acceptance Criteria

1. WHEN a new account is created, THE Tilly Application SHALL create a public profile group with "everyone" reader access
2. WHEN a new account is created, THE Tilly Application SHALL initialize the profile with a default display name
3. WHEN an account migration runs, THE Tilly Application SHALL ensure existing accounts have public profile groups
4. WHEN profile data is accessed, THE Tilly Application SHALL allow read access to all authenticated users

### Requirement 4: Replace Clerk Provider with Jazz Provider

**User Story:** As a developer, I want to use Jazz's native provider, so that authentication is handled consistently through the Jazz framework.

#### Acceptance Criteria

1. WHEN the application initializes, THE Tilly Application SHALL use JazzReactProvider instead of ClerkProvider
2. WHEN the application initializes, THE Tilly Application SHALL configure Jazz sync server connection
3. WHEN the application initializes, THE Tilly Application SHALL specify UserAccount as the AccountSchema
4. WHEN the provider is configured, THE Tilly Application SHALL NOT require Clerk-specific configuration

### Requirement 5: Update Settings Page Authentication Section

**User Story:** As a user, I want to manage my passkey authentication from the settings page, so that I can control my account access.

#### Acceptance Criteria

1. WHEN a user views the settings page, THE Tilly Application SHALL display current authentication status
2. WHEN an authenticated user views settings, THE Tilly Application SHALL show logged-in state with passkey indicator
3. WHEN an unauthenticated user views settings, THE Tilly Application SHALL display login and signup options
4. WHEN a user clicks logout, THE Tilly Application SHALL clear the session and refresh the application
5. WHERE the user is offline, THE Tilly Application SHALL disable authentication actions

### Requirement 6: Update Welcome Page Authentication

**User Story:** As a new user, I want to sign in from the welcome page, so that I can quickly access the application.

#### Acceptance Criteria

1. WHEN a user clicks "Sign In" on the welcome page, THE Tilly Application SHALL trigger the passkey login flow
2. WHEN the passkey login completes, THE Tilly Application SHALL mark the tour as skipped
3. WHEN the passkey login completes, THE Tilly Application SHALL navigate the user to the main application
4. WHEN the passkey login fails, THE Tilly Application SHALL display an error message

### Requirement 7: Implement Server-Side Authentication

**User Story:** As a developer, I want API requests to be authenticated using Jazz tokens, so that the server can verify user identity without Clerk.

#### Acceptance Criteria

1. WHEN a client makes an API request, THE Tilly Application SHALL include a Jazz authentication token in the Authorization header
2. WHEN the server receives an API request, THE Tilly Application SHALL validate the Jazz authentication token
3. WHEN token validation succeeds, THE Tilly Application SHALL load the authenticated account
4. WHEN token validation fails, THE Tilly Application SHALL return a 401 Unauthorized response
5. WHEN the authenticated account is loaded, THE Tilly Application SHALL use it as the user context for the request

### Requirement 8: Handle Cron Job User Enumeration

**User Story:** As a developer, I want to understand the limitations of user enumeration in Jazz, so that I can plan for push notification functionality.

#### Acceptance Criteria

1. WHEN the migration is complete, THE Tilly Application SHALL document that Jazz does not provide central user enumeration
2. WHEN the migration is complete, THE Tilly Application SHALL disable Clerk-dependent cron jobs in vercel.json
3. WHEN planning future features, THE Tilly Application SHALL consider implementing a Global Directory CoMap for user registry
4. WHEN the cron job is disabled, THE Tilly Application SHALL document the temporary nature of this solution

### Requirement 9: Maintain Existing User Experience

**User Story:** As a user, I want the application to work the same way after migration, so that I don't need to relearn the interface.

#### Acceptance Criteria

1. WHEN the migration is complete, THE Tilly Application SHALL maintain all existing features and functionality
2. WHEN the migration is complete, THE Tilly Application SHALL preserve the same UI/UX patterns
3. WHEN the migration is complete, THE Tilly Application SHALL maintain the same data structures and schemas
4. WHEN the migration is complete, THE Tilly Application SHALL continue to support offline functionality
5. WHEN the migration is complete, THE Tilly Application SHALL maintain real-time collaboration features

### Requirement 10: Ensure Type Safety

**User Story:** As a developer, I want all authentication code to be properly typed, so that I can catch errors at compile time.

#### Acceptance Criteria

1. WHEN authentication code is written, THE Tilly Application SHALL use proper TypeScript types for all Jazz auth functions
2. WHEN authentication code is written, THE Tilly Application SHALL NOT use type casts or "any" types
3. WHEN authentication code is written, THE Tilly Application SHALL leverage Jazz's type inference for loaded accounts
4. WHEN the migration is complete, THE Tilly Application SHALL pass TypeScript compilation without errors
5. WHEN the migration is complete, THE Tilly Application SHALL pass "pnpm check" without type errors
